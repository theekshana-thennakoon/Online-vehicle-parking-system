function paymentGateWay() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = () => {
        if (xhttp.readyState == 4 && xhttp.status == 200) {
            var obj = JSON.parse(xhttp.responseText);

            var siteOrigin = "http://localhost"; // Change to your domain in production
            var updateUrl = siteOrigin + "/updatePayment.php?order_id=" + encodeURIComponent(obj.order_id);
            var cancelUrl = siteOrigin + "/slots.php";

            // ========== PayHere event handlers ==========
            payhere.onCompleted = function (orderId) {
                alert("Payment completed. OrderID: " + orderId);
                console.log("âœ… Payment completed. OrderID:", orderId);
                // Redirect the parent page (checkpayment.php) to updatePayment.php
                try {
                    // If the gateway is in an iframe or overlay
                    if (window.top !== window) {
                        // window.top.location.href = updateUrl;
                        window.top.location.href = "./updatePayment.php?order_id=" + encodeURIComponent(orderId);
                    } else {
                        // Normal page
                        // window.location.href = updateUrl;
                        window.location.href = "./updatePayment.php?order_id=" + encodeURIComponent(orderId);
                    }

                    // If opened in a popup
                    if (window.opener) {
                        // window.opener.location.href = updateUrl;
                        window.opener.location.href = "./updatePayment.php?order_id=" + encodeURIComponent(orderId);
                        window.close();
                    }
                } catch (err) {
                    console.warn("Redirect failed, fallback:", err);
                    // window.location.href = updateUrl;
                    window.location.href = "./updatePayment.php?order_id=" + encodeURIComponent(orderId);
                }
            };

            payhere.onDismissed = function () {
                console.log("âŒ Payment dismissed.");
            };

            payhere.onError = function (error) {
                console.error("ðŸ’¥ Payment error:", error);
                alert("Payment error: " + error);
            };

            // ========== Payment object ==========
            var payment = {
                sandbox: !!obj.sandbox,
                merchant_id: obj.merchant_id,
                return_url: updateUrl,
                cancel_url: cancelUrl,
                notify_url: obj.notify_url || (siteOrigin + "/notify.php"),
                order_id: obj.order_id,
                items: obj.items,
                amount: obj.amount,
                currency: obj.currency,
                hash: obj.hash,
                first_name: obj.first_name,
                last_name: obj.last_name,
                email: obj.email,
                phone: obj.phone,
                address: obj.address,
                city: obj.city,
                country: "Sri Lanka",
                delivery_address: "No. 46, Galle road, Kalutara South",
                delivery_city: "Kalutara",
                delivery_country: "Sri Lanka",
                custom_1: obj.custom_1 || "",
                custom_2: obj.custom_2 || ""
            };

            // Start the payment
            payhere.startPayment(payment);
        }
    };
    xhttp.open("GET", "paymentprocess.php", true);
    xhttp.send();
}








if ($activity_id) {
    $sql = "UPDATE activity SET paid = 1 WHERE id = $activity_id";
    if ($conn->query($sql)) {
        // $_SESSION['user_exit'] = 1;
        // header("Location: ./slots.php");
    } else {
        echo "Database update failed.";
    }
} else {
    echo "Invalid data.";
}
